<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Conexi√≥n API - Acreditaciones TN</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 2rem;
            line-height: 1.6;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .test-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 1px solid #e0e0e0;
            border-radius: 0.5rem;
        }
        
        .test-section h2 {
            color: #007AFF;
            margin-bottom: 1rem;
        }
        
        .test-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        label {
            font-weight: 500;
            color: #333;
        }
        
        input, button {
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 0.5rem;
            font-size: 1rem;
        }
        
        input:focus {
            outline: none;
            border-color: #007AFF;
        }
        
        button {
            background: #007AFF;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s ease;
        }
        
        button:hover {
            background: #0056CC;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .result {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .result.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        
        .endpoint-list {
            list-style: none;
            padding: 0;
        }
        
        .endpoint-list li {
            padding: 0.5rem;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .endpoint-list li:last-child {
            border-bottom: none;
        }
        
        .endpoint-method {
            background: #007AFF;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
            margin-right: 1rem;
        }
        
        .endpoint-method.post {
            background: #28a745;
        }
        
        .endpoint-method.get {
            background: #007AFF;
        }
        
        .test-all-btn {
            background: #28a745;
            width: 100%;
            margin-top: 1rem;
        }
        
        .test-all-btn:hover {
            background: #218838;
        }
        
        .api-info {
            background: #e9ecef;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 2rem;
        }
        
        .api-info h3 {
            color: #495057;
            margin-bottom: 0.5rem;
        }
        
        .api-info p {
            color: #6c757d;
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîó Test de Conexi√≥n API - Acreditaciones TN</h1>
        
        <div class="api-info">
            <h3>üìã Informaci√≥n de la API</h3>
            <p><strong>URL Base:</strong> http://localhost/acreditacionestn2025/api/v1/</p>
            <p><strong>WebApp:</strong> http://localhost/acrdwebapp/</p>
        </div>
        
        <!-- Test de Conectividad B√°sica -->
        <div class="test-section">
            <h2>üì° Conectividad B√°sica</h2>
            <p>Verifica que la API est√© respondiendo correctamente.</p>
            <button onclick="testBasicConnectivity()">Probar Conectividad</button>
            <div id="connectivity-result" class="result" style="display: none;"></div>
        </div>
        
        <!-- Test de Login -->
        <div class="test-section">
            <h2>üîê Test de Login</h2>
            <p>Prueba el endpoint de autenticaci√≥n con credenciales de prueba.</p>
            <div class="test-form">
                <div class="form-group">
                    <label for="test-dni">DNI de Prueba:</label>
                    <input type="text" id="test-dni" placeholder="12345678" value="12345678">
                </div>
                <div class="form-group">
                    <label for="test-password">Contrase√±a de Prueba:</label>
                    <input type="password" id="test-password" placeholder="password123" value="password123">
                </div>
                <button onclick="testLogin()">Probar Login</button>
            </div>
            <div id="login-result" class="result" style="display: none;"></div>
        </div>
        
        <!-- Test de Endpoints P√∫blicos -->
        <div class="test-section">
            <h2>üåê Endpoints P√∫blicos</h2>
            <p>Prueba endpoints que no requieren autenticaci√≥n.</p>
            <ul class="endpoint-list">
                <li>
                    <div>
                        <span class="endpoint-method get">GET</span>
                        <span>/api/v1/promotions/active</span>
                    </div>
                    <button onclick="testEndpoint('/promotions/active', 'GET')">Probar</button>
                </li>
            </ul>
            <div id="public-result" class="result" style="display: none;"></div>
        </div>
        
        <!-- Test de Endpoints Protegidos -->
        <div class="test-section">
            <h2>üîí Endpoints Protegidos</h2>
            <p>Prueba endpoints que requieren autenticaci√≥n (necesita token v√°lido).</p>
            <ul class="endpoint-list">
                <li>
                    <div>
                        <span class="endpoint-method get">GET</span>
                        <span>/api/v1/user/profile</span>
                    </div>
                    <button onclick="testProtectedEndpoint('/user/profile', 'GET')">Probar</button>
                </li>
                <li>
                    <div>
                        <span class="endpoint-method get">GET</span>
                        <span>/api/v1/user/status</span>
                    </div>
                    <button onclick="testProtectedEndpoint('/user/status', 'GET')">Probar</button>
                </li>
                <li>
                    <div>
                        <span class="endpoint-method get">GET</span>
                        <span>/api/v1/user/team</span>
                    </div>
                    <button onclick="testProtectedEndpoint('/user/team', 'GET')">Probar</button>
                </li>
                <li>
                    <div>
                        <span class="endpoint-method get">GET</span>
                        <span>/api/v1/user/history</span>
                    </div>
                    <button onclick="testProtectedEndpoint('/user/history', 'GET')">Probar</button>
                </li>
            </ul>
            <div id="protected-result" class="result" style="display: none;"></div>
        </div>
        
        <!-- Test Completo -->
        <div class="test-section">
            <h2>üöÄ Test Completo</h2>
            <p>Ejecuta todas las pruebas autom√°ticamente.</p>
            <button class="test-all-btn" onclick="runAllTests()">Ejecutar Todas las Pruebas</button>
            <div id="all-tests-result" class="result" style="display: none;"></div>
        </div>
        
        <!-- Informaci√≥n de Debugging -->
        <div class="test-section">
            <h2>üîß Informaci√≥n de Debugging</h2>
            <p>Informaci√≥n √∫til para resolver problemas de conexi√≥n.</p>
            <button onclick="showDebugInfo()">Mostrar Info de Debug</button>
            <div id="debug-result" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost/acreditacionestn2025/api/v1';
        let authToken = null;
        
        // Funci√≥n para mostrar resultados
        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = `result ${type}`;
            element.textContent = content;
        }
        
        // Test de conectividad b√°sica
        async function testBasicConnectivity() {
            showResult('connectivity-result', 'Probando conectividad...', 'info');
            
            try {
                const response = await fetch(`${API_BASE_URL}/promotions/active`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showResult('connectivity-result', 
                        `‚úÖ Conectividad OK!\n\nStatus: ${response.status}\nResponse: ${JSON.stringify(data, null, 2)}`, 
                        'success'
                    );
                } else {
                    showResult('connectivity-result', 
                        `‚ùå Error de conectividad\n\nStatus: ${response.status}\nStatus Text: ${response.statusText}`, 
                        'error'
                    );
                }
            } catch (error) {
                showResult('connectivity-result', 
                    `‚ùå Error de conexi√≥n\n\nError: ${error.message}\n\nVerifica que:\n- La API est√© ejecut√°ndose en ${API_BASE_URL}\n- No haya problemas de CORS\n- El servidor web est√© funcionando`, 
                    'error'
                );
            }
        }
        
        // Test de login
        async function testLogin() {
            const dni = document.getElementById('test-dni').value;
            const password = document.getElementById('test-password').value;
            
            if (!dni || !password) {
                showResult('login-result', '‚ùå Por favor completa DNI y contrase√±a', 'error');
                return;
            }
            
            showResult('login-result', 'Probando login...', 'info');
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ dni, password })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    authToken = data.data.token;
                    localStorage.setItem('test_token', authToken);
                    showResult('login-result', 
                        `‚úÖ Login exitoso!\n\nToken: ${authToken.substring(0, 50)}...\n\nUsuario: ${JSON.stringify(data.data.user, null, 2)}`, 
                        'success'
                    );
                } else {
                    showResult('login-result', 
                        `‚ùå Error en login\n\nStatus: ${response.status}\nResponse: ${JSON.stringify(data, null, 2)}`, 
                        'error'
                    );
                }
            } catch (error) {
                showResult('login-result', 
                    `‚ùå Error de conexi√≥n en login\n\nError: ${error.message}`, 
                    'error'
                );
            }
        }
        
        // Test de endpoint p√∫blico
        async function testEndpoint(endpoint, method = 'GET') {
            showResult('public-result', `Probando ${method} ${endpoint}...`, 'info');
            
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showResult('public-result', 
                        `‚úÖ ${method} ${endpoint} OK!\n\nStatus: ${response.status}\nResponse: ${JSON.stringify(data, null, 2)}`, 
                        'success'
                    );
                } else {
                    showResult('public-result', 
                        `‚ùå Error en ${method} ${endpoint}\n\nStatus: ${response.status}\nResponse: ${JSON.stringify(data, null, 2)}`, 
                        'error'
                    );
                }
            } catch (error) {
                showResult('public-result', 
                    `‚ùå Error de conexi√≥n en ${method} ${endpoint}\n\nError: ${error.message}`, 
                    'error'
                );
            }
        }
        
        // Test de endpoint protegido
        async function testProtectedEndpoint(endpoint, method = 'GET') {
            if (!authToken) {
                // Intentar obtener token del localStorage
                authToken = localStorage.getItem('test_token');
                if (!authToken) {
                    showResult('protected-result', 
                        '‚ùå No hay token de autenticaci√≥n. Primero ejecuta el test de login.', 
                        'error'
                    );
                    return;
                }
            }
            
            showResult('protected-result', `Probando ${method} ${endpoint} con token...`, 'info');
            
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showResult('protected-result', 
                        `‚úÖ ${method} ${endpoint} OK!\n\nStatus: ${response.status}\nResponse: ${JSON.stringify(data, null, 2)}`, 
                        'success'
                    );
                } else {
                    showResult('protected-result', 
                        `‚ùå Error en ${method} ${endpoint}\n\nStatus: ${response.status}\nResponse: ${JSON.stringify(data, null, 2)}`, 
                        'error'
                    );
                }
            } catch (error) {
                showResult('protected-result', 
                    `‚ùå Error de conexi√≥n en ${method} ${endpoint}\n\nError: ${error.message}`, 
                    'error'
                );
            }
        }
        
        // Ejecutar todas las pruebas
        async function runAllTests() {
            showResult('all-tests-result', 'üöÄ Iniciando test completo...\n\n', 'info');
            
            const results = [];
            
            // Test 1: Conectividad b√°sica
            try {
                const response = await fetch(`${API_BASE_URL}/promotions/active`);
                if (response.ok) {
                    results.push('‚úÖ Conectividad b√°sica: OK');
                } else {
                    results.push(`‚ùå Conectividad b√°sica: Error ${response.status}`);
                }
            } catch (error) {
                results.push(`‚ùå Conectividad b√°sica: ${error.message}`);
            }
            
            // Test 2: Login
            try {
                const loginResponse = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ dni: '12345678', password: 'password123' })
                });
                
                const loginData = await loginResponse.json();
                if (loginResponse.ok && loginData.success) {
                    authToken = loginData.data.token;
                    results.push('‚úÖ Login: OK');
                } else {
                    results.push(`‚ùå Login: Error ${loginResponse.status}`);
                }
            } catch (error) {
                results.push(`‚ùå Login: ${error.message}`);
            }
            
            // Test 3: Endpoints protegidos (si hay token)
            if (authToken) {
                const protectedEndpoints = ['/user/profile', '/user/status', '/user/team', '/user/history'];
                
                for (const endpoint of protectedEndpoints) {
                    try {
                        const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                            headers: {
                                'Authorization': `Bearer ${authToken}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (response.ok) {
                            results.push(`‚úÖ ${endpoint}: OK`);
                        } else {
                            results.push(`‚ùå ${endpoint}: Error ${response.status}`);
                        }
                    } catch (error) {
                        results.push(`‚ùå ${endpoint}: ${error.message}`);
                    }
                }
            }
            
            // Mostrar resultados
            const summary = results.join('\n');
            const successCount = results.filter(r => r.includes('‚úÖ')).length;
            const totalCount = results.length;
            
            showResult('all-tests-result', 
                `üéØ Test Completo Finalizado\n\n${summary}\n\nüìä Resumen: ${successCount}/${totalCount} pruebas exitosas`, 
                successCount === totalCount ? 'success' : 'error'
            );
        }
        
        // Mostrar informaci√≥n de debugging
        function showDebugInfo() {
            const debugInfo = `
üîß Informaci√≥n de Debugging

üìç URLs:
- API Base: ${API_BASE_URL}
- WebApp: ${window.location.origin}
- User Agent: ${navigator.userAgent}

üåê Conectividad:
- Online: ${navigator.onLine ? 'S√≠' : 'No'}
- Protocol: ${window.location.protocol}
- Host: ${window.location.host}

üîë Token:
- Token guardado: ${localStorage.getItem('test_token') ? 'S√≠' : 'No'}
- Token actual: ${authToken ? 'S√≠' : 'No'}

üìã Pr√≥ximos pasos si hay errores:
1. Verificar que la API est√© ejecut√°ndose en http://localhost/acreditacionestn2025/
2. Comprobar que no haya errores en la consola del navegador
3. Verificar configuraci√≥n CORS en la API
4. Comprobar que el servidor web est√© funcionando
5. Verificar que las rutas de la API est√©n configuradas correctamente

üîó URLs para probar manualmente:
- ${API_BASE_URL}/promotions/active
- ${API_BASE_URL}/auth/login
- ${API_BASE_URL}/user/profile (requiere token)
            `;
            
            showResult('debug-result', debugInfo, 'info');
        }
        
        // Cargar token guardado al iniciar
        window.addEventListener('load', () => {
            const savedToken = localStorage.getItem('test_token');
            if (savedToken) {
                authToken = savedToken;
                console.log('Token cargado desde localStorage');
            }
        });
    </script>
</body>
</html>
